<!DOCTYPE html>
  <head>
    <title>INFO 3300 Project 2</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
  </head>
  <style>
     .nation {
        fill: #ddd;
      }

    .outline {
      stroke: #fff;
      stroke-width: 1px;
      fill: none;
    }

    #master-container{
      display: flex;
      flex-direction:row;
      width: 100%;
    }
    .map{
      width: 65%;
    }
    .filter{
      width: 25%;
      margin: 20px;
      display:inline-block
    }
    #slider{
      width: 100%;
      margin: 20px;
    }
    #slide-label{
      margin: 20px;
    }
  </style>
  <body>
    <div id = "master-container">
      <div class = "map">
        <svg class = "child" id = "deathsmap" width = 975 height = 610 ></svg>
      </div>
      <div class = "filter" id = "filter">
        <div id = "years"></div>
      </div>

    </div>
    <script>
      const getData = async function(){
        // data set from https://mappingpoliceviolence.org/ 
        let data = await d3.csv("police_cleaned.csv");
        

        // mesh / outline dataset from INFO 3300 repository <-- Jeff Rzeszotarski
        const svg = d3.select("#deathsmap");
        const width = svg.attr("width");
        const height = svg.attr("height");
        const map = svg.append("g");
        
        const us = await d3.json("counties-10m.json");
        var projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
        var path = d3.geoPath().projection(projection);
        var nation = topojson.feature(us, us.objects.nation);
        var statesMesh = topojson.mesh(us, us.objects.states);
        
        
        data.forEach( d => {
          let comma = d.coordinates.indexOf(",");
          d.latitude = Number(d.coordinates.substring(1, comma));
          d.longitude = Number(d.coordinates.substring(comma + 1, d.coordinates.length - 1));
          d.position = projection( [d.longitude, d.latitude] );
        })

        data = data.filter(function(d){
          return d.position !== null;
        });

        let groups = d3.group(data, d => d.City);

        let new_groups = Array.from(groups);

        let circleExtent = d3.extent(new_groups, d => d[1].length)
        let circleScale = d3.scaleLinear().domain(circleExtent).range([1, 15]);

        map.selectAll("path.nation").data(nation.features)
         .join("path")
         .attr("class", "nation")
         .attr("d", path);
  
        map.append("path").datum(statesMesh)
         .attr("class","outline")
         .attr("d", path);

        map.selectAll("circle.dot").data(new_groups)
         .join("circle")
         .attr("class","dot")
         .attr("r", d => circleScale(d[1].length))
         .attr("fill", "darkred")
         .attr("opacity", 0.4)
         .attr("cx", d => d[1][0].position[0])
         .attr("cy", d => d[1][0].position[1])
         .attr("data", d => d[1].length);


        var zoom = d3.zoom()
                    .scaleExtent([1, Infinity])
                    .translateExtent([[0, 0], [width, height]])
                    .extent([[0, 0], [width, height]])
                    .on('zoom', function(event) {
                        svg.selectAll('path').attr('transform', event.transform)
                        map.selectAll('circle').attr('transform', event.transform);
                });
        svg.call(zoom);
    
        let years = Array.from(new Set( d3.map(data, d => d["year"]))).sort();
        console.log(years);
        console.log(new_groups[0]);
        
        console.log(circleExtent);
        d3.select("div#filter").append("span").attr("id", "slide-label").text("More than 1 killing")
        d3.select("div#filter").append("input")
                                .attr("type", "range")
                                .attr("value", 1)
                                .attr("min",(circleExtent[0]))
                                .attr("max", (circleExtent[1]))
                                .attr("id", "slider")
                                .attr("width", "400px")
                                .attr("steps", 1)
                                .on("change", function(){
                                  updateSlide(this.value)
                                });
                                // .on("input", function(){
                                //   updateMap(this.value)});
        
        function updateSlide(v){
          //d3.select("#slider").property("value", v);
          let lastWord = " killings";
          if (v === "1"){
            lastWord = " killing"
          }

          d3.select("#slide-label").text("More than " + v + lastWord);
          console.log(v)
          d3.selectAll("circle.dot").each( function () {
            let circle = d3.select(this);
            let data = circle.attr("data")
            // console.log(typeof(v))
            // console.log(typeof(data))
            //console.log(data);
            if (Number(data) < Number(v)){
              circle.attr("visibility", "hidden");
            }else{
              circle.attr("visibility", "");
            }
          })
        }
        // function updateMap(v){
        //   d3.selectAll("#dot").each( function () {
        //     let circle = d3.select(this);
        //     console.log("m")
        //     if (circle.data < v){
        //       circle.attr("visibility", "hidden");
        //     }else{
        //       circle.attr("visibility", "");
        //     }
        //   })
        // }
       
    }
    getData();
  
    </script>
  </body>
</html>
