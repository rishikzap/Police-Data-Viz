<!DOCTYPE html>
  <head>
    <title>INFO 3300 Project 2</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
  </head>
  <style>
     .nation {
        fill: #ddd;
      }

    .outline {
      stroke: #fff;
      stroke-width: 1px;
      fill: none;
    }
  </style>
  <body>
    <svg id = "deathsmap" width = 975 height = 610 ></svg>
    <svg id = "victims" width = 301 height = 610></svg>
    <script>
      const getData = async function(){
        // data set from https://mappingpoliceviolence.org/ 
        let data = await d3.csv("police_cleaned.csv");
        

        // mesh / outline dataset from INFO 3300 repository <-- Jeff Rzeszotarski
        const svg = d3.select("#deathsmap");
        const width = svg.attr("width");
        const height = svg.attr("height");
        const map = svg.append("g");
        
        const us = await d3.json("counties-10m.json");
        var projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
        var path = d3.geoPath().projection(projection);
        var nation = topojson.feature(us, us.objects.nation);
        var statesMesh = topojson.mesh(us, us.objects.states);
        
        
        data.forEach( d => {
          let comma = d.coordinates.indexOf(",");
          d.latitude = Number(d.coordinates.substring(1, comma));
          d.longitude = Number(d.coordinates.substring(comma + 1, d.coordinates.length - 1));
          d.position = projection( [d.longitude, d.latitude] );
        })

        data = data.filter(function(d){
          return d.position !== null;
        });

        data.forEach( d => {
          if(d.position === null)
            console.log(d);
        })

        let groups = d3.group(data, d => d.City);

        let new_groups = Array.from(groups);

        let circleExtent = d3.extent(new_groups, d => d[1].length)
        let circleScale = d3.scaleLinear().domain(circleExtent).range([1, 15]);

        map.selectAll("path.nation").data(nation.features)
         .join("path")
         .attr("class", "nation")
         .attr("d", path);
  
        map.append("path").datum(statesMesh)
         .attr("class","outline")
         .attr("d", path);

        let circles = map.selectAll("circle.dot").data(new_groups)
                          .join("circle")
                          .attr("class","dot")
                          .attr("r", d => circleScale(d[1].length))
                          .attr("fill", "darkred")
                          .attr("opacity", 0.4)
                          .attr("cx", d => d[1][0].position[0])
                          .attr("cy", d => d[1][0].position[1]);


        d3.selectAll(".dot").on("click", clickedCircle);
        
        let lastClicked;
        const sidebar = d3.select("#victims");
        const mouseover = sidebar.append("g").attr("class","mouseover")
                       .attr("transform",`translate(0,0)`);
        const frame = mouseover.append("rect").attr("class","frame")
                         // we style this in <head>
                         .attr("x", 0).attr("y", 0)
                         .attr("rx", 5).attr("ry", 5)  // rx and ry round corners
                         .attr("height", 130);  // set width later
        const textbox = mouseover.append("g").attr("transform","translate(10,10)");

        function clickedCircle() {
          if(lastClicked != null) {
            lastClicked.attr("stroke-width", 0);
          }

          let dot = d3.select(this);

          lastClicked = dot;

          d3.select(this).attr("stroke","black")
                         .attr("stroke-opacity", "100%")
                         .attr("stroke-width", d => circleScale(d[1].length) / 4);
          
          console.log(dot.datum());
          textbox.html(''); 
          textbox.append("text").text(dot.datum()[0])
                 .attr("x", 0).attr("y", 10);

          let deaths = dot.datum()[1];

          let xpos = 50;
          let ypos = 50;

          deaths.forEach(d => {
            d.xposition = xpos;
            d.yposition = ypos;
            xpos += 20;
            xpos = xpos % 250;
            if(xpos === 0) {
              ypos += 20;
              ypos = ypos % 615;
              xpos = 50;
            }
          })

          sidebar.selectAll("circle.death").data(deaths)
                          .join("circle")
                          .attr("class","death")
                          .attr("r", 5)
                          .attr("fill", "darkred")
                          .attr("cx", d => d.xposition)
                          .attr("cy", d => d.yposition);
        }

        var zoomG = svg.append("g");

        var zoom = d3.zoom()
                    .scaleExtent([1, Infinity])
                    .translateExtent([[0, 0], [width, height]])
                    .extent([[0, 0], [width, height]])
                    .on('zoom', function(event) {
                        svg.selectAll('path').attr('transform', event.transform)
                        map.selectAll('circle').attr('transform', event.transform);
                });
        svg.call(zoom);
      }
      getData();
  
    </script>
  </body>
</html>
