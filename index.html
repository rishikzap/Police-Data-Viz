<!DOCTYPE html>
  <head>
    <title>INFO 3300 Project 2</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
  </head>
  <style>

     html{
      font-family:'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
      background-color: slategray;
      color: white;
     }

     svg {
       fill: white;
     }

     .nation {
        fill: lightgrey;
      }

    .outline {
      stroke: #fff;
      stroke-width: 1px;
      fill: none;
    }

    #master-container{
      display: flex;
      flex-direction:row;
      width: 100%;
    }
    .map{
      display: inline-block;
      background-color: white;
      height: 625px;
    }
    .filter{
      width: 250px;
      margin: 20px;
      margin-bottom: 0px;
      display:inline-block
    }
    .filters{
      display:flex;
      flex-direction: column;
      width: 100%;
    }
    #slider{
      width: 75%;
      margin: 30px;
    }
    #slide-label{
      margin: 30px;
    }
    .side{
      display: flex;
      flex-direction: column;
      width: 100%;
    }
    #victims, #individuals{
      margin: 30px;
      display: flex;
      margin-top: 0px;
      margin-bottom: 0px;
      padding-top: 15px;
      padding-bottom: 15px;
    }

    #individuals {
      margin-left: 0px;
      padding-bottom: 0px;
    }


    .description{
      padding: 20px;
    }

    .card {
      border-radius: 15px;
      background-color: lightgrey;
      width: 301px;
      margin-left: 30px;
      margin-bottom: 10px;
    }

    #card2, #card3 {
      background-color: slategray;
    }

    #title {
      text-align: center;
    }

    #card-info {
      width: 500px;
      padding: 15px;
      margin-top: 20px;
    }

    .info-wrapper {
      width: 975px;
      display: flex;
      justify-content: center;
    }

    #card4 {
      background-color: slategray;
    }

  </style>
  <body>
    <div id="title-box">
      <h1 id="title">Police Encounters</h1>
    </div>
    <div id = "master-container">
        <div class="map">
          <svg class = "child" id = "deathsmap" width = 975 height = 625 ></svg>
          <div class="info-wrapper">
            <div id="card-info" class="card">
              <div class = "INFO">
                Navigate the map by scrolling to zoom and dragging the cursor to move. Click on a point that 
                  represents a city or town to view the number of killings. Then, click on a specific killing 
                  to get more information about the encounter.
              </div>
            </div>
          </div>
        </div>
        <div class="filters">
          <div id = "card1" class = "card">
            <div class = "filter" id = "filter"></div> 
          </div>
          <div id = "card2" class = "card">
            <svg id = "victims" width = 301 height = 460></svg>
          </div>
          <div id = "card3" class="card">
            <svg id ="individuals" width = 301 height = "145"></svg>
          </div>
          <div id= "card4" class="card desc">
            
          </div>
        </div>
    </div>
    
    
    <script>
      const getData = async function(){
        // data set from https://mappingpoliceviolence.org/ 
        let data = await d3.csv("police_cleaned.csv");
        
        // mesh / outline dataset from INFO 3300 repository <-- Jeff Rzeszotarski
        const svg = d3.select("#deathsmap");
        const width = svg.attr("width");
        const height = svg.attr("height");
        const map = svg.append("g");
        
        const us = await d3.json("counties-10m.json");
        var projection = d3.geoAlbersUsa().scale(1300).translate([487.5, 305]);
        var path = d3.geoPath().projection(projection);
        var nation = topojson.feature(us, us.objects.nation);
        var statesMesh = topojson.mesh(us, us.objects.states);
        
        
        data.forEach( d => {
          let comma = d.coordinates.indexOf(",");
          d.latitude = Number(d.coordinates.substring(1, comma));
          d.longitude = Number(d.coordinates.substring(comma + 1, d.coordinates.length - 1));
          if (d.City === "Indianapolis"){ // indianapolis falsely classified by geocoder 
            d.position = projection ([-86.1583502, 39.7683331])
          }else{
            d.position = projection( [d.longitude, d.latitude] );
          }
        })

        data = data.filter(function(d){
          return d.position !== null;
        });

        let groups = d3.group(data, d => d.City);

        let new_groups = Array.from(groups);

        let circleExtent = d3.extent(new_groups, d => d[1].length)
        let circleScale = d3.scaleLinear().domain(circleExtent).range([1, 15]);

        map.selectAll("path.nation").data(nation.features)
         .join("path")
         .attr("class", "nation")
         .attr("d", path);
  
        map.append("path").datum(statesMesh)
         .attr("class","outline")
         .attr("d", path);

        function drawCircs(){
            map.selectAll("circle.dot").data(new_groups)
                    .join("circle")
                    .attr("class","dot")
                    .attr("r", d => circleScale(d[1].length))
                    .attr("fill", "darkred")
                    .attr("opacity", 0.4)
                    .attr("cx", d => d[1][0].position[0])
                    .attr("cy", d => d[1][0].position[1])
                    .attr("data", d => d[1].length);
        }

        var zoom = d3.zoom()
                    .scaleExtent([1, Infinity])
                    .translateExtent([[0, 0], [width, height]])
                    .extent([[0, 0], [width, height]])
                    .on('zoom', function(event) {
                        svg.selectAll('path').attr('transform', event.transform)
                        map.selectAll('circle').attr('transform', event.transform);
                });
        svg.call(zoom);
        

        d3.select("div#filter").append("span").attr("id", "slide-label").text("More than 1 killing")
        d3.select("div#filter").append("input")
                                .attr("type", "range")
                                .attr("value", 1)
                                .attr("min",(circleExtent[0]))
                                .attr("max", (circleExtent[1]))
                                .attr("id", "slider")
                                .attr("width", "400px")
                                .attr("steps", 1)
                                .on("input", function(){
                                  updateSlide(this.value)
                                });
                                
        drawCircs();    
        function updateSlide(v){
          //d3.select("#slider").property("value", v);
          let lastWord = " killings";
          if (v === "1"){
            lastWord = " killing"
          }

          d3.select("#slide-label").text("More than " + v + lastWord);
   
          d3.selectAll("circle.dot").each( function () {
            let circle = d3.select(this);
            let data = circle.attr("data")
            if (Number(data) < Number(v)){
              circle.attr("visibility", "hidden");
            }else{
              circle.attr("visibility", "");
            }
          }) 
        }

        d3.selectAll("circle.dot").on("click", clickedCircle);
        
        let lastClicked;
        const sidebar = d3.select("#victims");
        const mouseover = sidebar.append("g").attr("class","mouseover")
                       .attr("transform",`translate(0,0)`);
        const frame = mouseover.append("rect").attr("class","frame")
                         // we style this in <head>
                         .attr("x", 0).attr("y", 0)
                         .attr("rx", 5).attr("ry", 5)  // rx and ry round corners
                         .attr("height", 130);  // set width later
        const textbox = mouseover.append("g").attr("transform","translate(20,10)");
        const info = d3.select("#individuals");
        const info_mouseover = info.append("g").attr("class","info_mouseover")
                       .attr("transform",`translate(0,0)`);
        const info_frame = info_mouseover.append("rect").attr("class","info_frame")
                         // we style this in <head>
                         .attr("x", 0).attr("y", 0)
                         .attr("rx", 5).attr("ry", 5)  // rx and ry round corners
                         .attr("height", 130);  // set width later
        const info_textbox = info_mouseover.append("g").attr("transform","translate(20,10)");
        
        let deathsInCity;
        
        function drawPeople(dot) {
          console.log(dot.datum());
          textbox.html(''); 
          textbox.append("text").text(dot.datum()[0])
                 .attr("x", 0).attr("y", 10);

           let deaths = dot.datum()[1];

           let numDeaths = deaths.length;

           let numRows = Math.floor(numDeaths / 10);

          sidebar.attr("height", (numRows * 28) + 100)

          console.log("height: "+((numRows * 28) + 100))

           let xpos = 18;
           let ypos = 50;

          deaths.forEach(d => {
            d.xposition = xpos;
            d.yposition = ypos;
            xpos += 20;
            xpos = xpos % 218;
            if(xpos === 0) {
              ypos += 30;
              ypos = ypos % 615;
              xpos = 18;
            }
          })

          deathsInCity = sidebar.selectAll("image.death").data(deaths)
                          .enter()
                          .append('image')
                          .attr("xlink:href", "standing-up-man-.svg")
                          .attr("class","death")
                          .attr("r", 5)
                          .attr("fill", "darkred")
                          .attr("x", d => d.xposition)
                          .attr("y", d => d.yposition)
                          .attr("width", 20)
                          .attr("height", 20);
        }

        d3.select("div.desc").append("div").attr("class", "description").attr("id", "description");
        d3.select("div.desc").append("a").attr("class", "description").attr("id", "url").attr("target", "_blank");

        function clickedCircle() {
          document.getElementById("description").innerHTML = "";
          document.getElementById("url").innerHTML = "";
          document.getElementById("card2").style.backgroundColor = "lightgrey";
          document.getElementById("card3").style.backgroundColor = "slategray";
          document.getElementById("card4").style.backgroundColor = "slategray";

          info_textbox.html(''); 
          const victimSvg = d3.select("#victims");
          victimSvg.selectAll("image.death").remove();
          if(lastClicked != null) {
            lastClicked.attr("stroke-width", 0);
          }

          let dot = d3.select(this);

          lastClicked = dot;

          d3.select(this).attr("stroke","black")
                         .attr("stroke-opacity", "100%")
                         .attr("stroke-width", d => circleScale(d[1].length) / 4);

          drawPeople(dot);
                 
          let lastMan;
          d3.selectAll("image.death").on("click", clickedDeath);
          function clickedDeath() {
            document.getElementById("description").innerHTML = "";
            document.getElementById("url").innerHTML = "";
            document.getElementById("card3").style.backgroundColor = "lightgrey";
            document.getElementById("card4").style.backgroundColor = "lightgrey";
            d3.select("#card2").attr("background-color", "lightgrey");
            info_textbox.html(''); 
            let d = d3.select(this).datum();
            if(lastMan != null) {
              lastMan.attr("xlink:href", "standing-up-man-.svg");
            }

            lastMan = d3.select(this);

            d3.select(this).attr("xlink:href", "red-man-standing.svg")
            console.log(d);
            let name = `Victim's Name: ${d['Victim\'s name']}`;
            let age = `Victim's Age: ${d['Victim\'s age']}`;
            let gender = `Victim's Gender: ${d['Victim\'s gender']}`;
            let race = `Victim's Race: ${d['Victim\'s race']}`;
            let cause = `Cause of Death: ${d["Cause of death"]}`
            let b_desc = d["A brief description of the circumstances surrounding the death"];
            let date = d["Date of Incident (month/day/year)"];
            let url = d["Link to news article or photo of official document"];

            info_textbox.append("text").text(name)
                  .attr("x", 0).attr("y", 10);
            info_textbox.append("text").text(age)
                  .attr("x", 0).attr("y", 30);
            info_textbox.append("text").text(gender)
                  .attr("x", 0).attr("y", 50);
            info_textbox.append("text").text(race)
                  .attr("x", 0).attr("y", 70);
            info_textbox.append("text").text(cause)
                  .attr("x", 0).attr("y", 90);
            d3.select("div.description").text("Desciption: "+b_desc);
            info_textbox.append("text").text(date)
                  .attr("x", 0).attr("y", 110);
            d3.select("a#url").attr("href", url).append("span").text("More Info");
          } 
        }

      }
    getData();
    
    </script>
  </body>
</html>
